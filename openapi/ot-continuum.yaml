openapi: 3.1.0
info:
  title: OT Continuum API
  version: 1.0.0
  description: Multi-tenant SaaS API for operational technology risk management
  contact:
    name: OT Continuum Support
    email: support@otcontinuum.com
  license:
    name: Proprietary

servers:
  - url: https://{projectId}.supabase.co/functions/v1/make-server-fb677d93
    description: Supabase Edge Function
    variables:
      projectId:
        default: your-project-id
        description: Your Supabase project ID

security:
  - BearerAuth: []

tags:
  - name: Organizations
    description: Organization management
  - name: Sites
    description: Site management
  - name: Risks
    description: Risk register operations
  - name: Billing
    description: Billing and subscriptions
  - name: Auth
    description: Authentication

paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /auth/signup:
    post:
      summary: Create new user account
      operationId: signup
      tags:
        - Auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

  /organizations:
    get:
      summary: List user's organizations
      operationId: listOrganizations
      tags:
        - Organizations
      responses:
        '200':
          description: List of organizations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create new organization
      operationId: createOrganization
      tags:
        - Organizations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /organizations/{orgId}:
    get:
      summary: Get organization details
      operationId: getOrganization
      tags:
        - Organizations
      parameters:
        - $ref: '#/components/parameters/OrgId'
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update organization
      operationId: updateOrganization
      tags:
        - Organizations
      parameters:
        - $ref: '#/components/parameters/OrgId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrganizationRequest'
      responses:
        '200':
          description: Organization updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations/{orgId}/sites:
    get:
      summary: List organization sites
      operationId: listSites
      tags:
        - Sites
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, archived]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Site'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create new site
      operationId: createSite
      tags:
        - Sites
      parameters:
        - $ref: '#/components/parameters/OrgId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSiteRequest'
      responses:
        '201':
          description: Site created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /organizations/{orgId}/sites/{siteId}:
    get:
      summary: Get site details
      operationId: getSite
      tags:
        - Sites
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/SiteId'
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update site
      operationId: updateSite
      tags:
        - Sites
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/SiteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSiteRequest'
      responses:
        '200':
          description: Site updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete site
      operationId: deleteSite
      tags:
        - Sites
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/SiteId'
      responses:
        '204':
          description: Site deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations/{orgId}/risks:
    get:
      summary: List organization risks
      operationId: listRisks
      tags:
        - Risks
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - name: status
          in: query
          schema:
            type: string
            enum: [open, mitigating, closed, accepted]
        - name: min_score
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 25
        - name: site_id
          in: query
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of risks
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Risk'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create new risk
      operationId: createRisk
      tags:
        - Risks
      parameters:
        - $ref: '#/components/parameters/OrgId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRiskRequest'
      responses:
        '201':
          description: Risk created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /organizations/{orgId}/risks/{riskId}:
    get:
      summary: Get risk details
      operationId: getRisk
      tags:
        - Risks
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/RiskId'
      responses:
        '200':
          description: Risk details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update risk
      operationId: updateRisk
      tags:
        - Risks
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/RiskId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRiskRequest'
      responses:
        '200':
          description: Risk updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete risk
      operationId: deleteRisk
      tags:
        - Risks
      parameters:
        - $ref: '#/components/parameters/OrgId'
        - $ref: '#/components/parameters/RiskId'
      responses:
        '204':
          description: Risk deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /organizations/{orgId}/subscription:
    get:
      summary: Get organization subscription
      operationId: getSubscription
      tags:
        - Billing
      parameters:
        - $ref: '#/components/parameters/OrgId'
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /billing/plans:
    get:
      summary: List available billing plans
      operationId: listBillingPlans
      tags:
        - Billing
      responses:
        '200':
          description: List of billing plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BillingPlan'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    OrgId:
      name: orgId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Organization ID

    SiteId:
      name: siteId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Site ID

    RiskId:
      name: riskId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Risk ID

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        timestamp:
          type: string
          format: date-time

    SignupRequest:
      type: object
      required:
        - email
        - password
        - full_name
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        full_name:
          type: string

    AuthResponse:
      type: object
      properties:
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string
            full_name:
              type: string
        access_token:
          type: string

    Organization:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        is_active:
          type: boolean
        settings:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateOrganizationRequest:
      type: object
      required:
        - name
        - slug
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        slug:
          type: string
          pattern: '^[a-z0-9-]+$'
          minLength: 1
          maxLength: 50

    UpdateOrganizationRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        is_active:
          type: boolean
        settings:
          type: object

    Site:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        name:
          type: string
        location:
          type: string
        site_code:
          type: string
        status:
          type: string
          enum: [active, inactive, archived]
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateSiteRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        location:
          type: string
        site_code:
          type: string
          pattern: '^[A-Z0-9-]+$'
        status:
          type: string
          enum: [active, inactive, archived]
          default: active
        metadata:
          type: object

    UpdateSiteRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        location:
          type: string
        status:
          type: string
          enum: [active, inactive, archived]
        metadata:
          type: object

    Risk:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        site_id:
          type: string
          format: uuid
          nullable: true
        category_id:
          type: string
          format: uuid
          nullable: true
        title:
          type: string
        description:
          type: string
        likelihood:
          type: integer
          minimum: 1
          maximum: 5
        impact:
          type: integer
          minimum: 1
          maximum: 5
        risk_score:
          type: integer
          minimum: 1
          maximum: 25
          readOnly: true
        status:
          type: string
          enum: [open, mitigating, closed, accepted]
        mitigation_plan:
          type: string
        owner_id:
          type: string
          format: uuid
          nullable: true
        identified_date:
          type: string
          format: date
        review_date:
          type: string
          format: date
          nullable: true
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateRiskRequest:
      type: object
      required:
        - title
        - likelihood
        - impact
      properties:
        site_id:
          type: string
          format: uuid
        category_id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: string
        likelihood:
          type: integer
          minimum: 1
          maximum: 5
        impact:
          type: integer
          minimum: 1
          maximum: 5
        status:
          type: string
          enum: [open, mitigating, closed, accepted]
          default: open
        mitigation_plan:
          type: string
        owner_id:
          type: string
          format: uuid
        identified_date:
          type: string
          format: date
        review_date:
          type: string
          format: date
        metadata:
          type: object

    UpdateRiskRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: string
        likelihood:
          type: integer
          minimum: 1
          maximum: 5
        impact:
          type: integer
          minimum: 1
          maximum: 5
        status:
          type: string
          enum: [open, mitigating, closed, accepted]
        mitigation_plan:
          type: string
        owner_id:
          type: string
          format: uuid
        review_date:
          type: string
          format: date
        metadata:
          type: object

    BillingPlan:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        price_monthly:
          type: number
          format: decimal
        price_yearly:
          type: number
          format: decimal
        max_users:
          type: integer
          nullable: true
        max_sites:
          type: integer
          nullable: true
        features:
          type: object
        is_active:
          type: boolean

    Subscription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        plan_id:
          type: string
          format: uuid
        plan:
          $ref: '#/components/schemas/BillingPlan'
        status:
          type: string
          enum: [active, past_due, cancelled, trialing]
        billing_cycle:
          type: string
          enum: [monthly, yearly]
        current_period_start:
          type: string
          format: date-time
        current_period_end:
          type: string
          format: date-time
        cancel_at_period_end:
          type: boolean
        trial_end:
          type: string
          format: date-time
          nullable: true

    Pagination:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Conflict:
      description: Resource conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
