openapi: 3.0.3
info:
  title: OT Continuum API
  version: 1.0.0
  description: |
    Multi-tenant operational technology risk management platform.
    
    ## Authentication
    All endpoints require a Bearer token in the Authorization header:
    ```
    Authorization: Bearer <your_token>
    ```
    
    ## Multi-Tenancy
    All requests are automatically scoped to the authenticated user's tenant via JWT claims.
    
    ## Rate Limiting
    - 1000 requests per hour per user
    - 10000 requests per hour per tenant
  contact:
    name: OT Continuum API Support
    email: api-support@otcontinuum.com
  license:
    name: Proprietary
    url: https://otcontinuum.com/license

servers:
  - url: https://{project_id}.supabase.co/functions/v1/make-server-fb677d93
    description: Production server
    variables:
      project_id:
        default: your-project-id
        description: Your Supabase project ID
  - url: http://localhost:54321/functions/v1/make-server-fb677d93
    description: Local development server

tags:
  - name: tenants
    description: Tenant management
  - name: users
    description: User profiles and management
  - name: sites
    description: Operational sites and facilities
  - name: signals
    description: Raw and validated operational signals
  - name: workflows
    description: Workflow definitions and templates
  - name: work_items
    description: Workflow instances and tasks
  - name: risks
    description: Risk register and assessments
  - name: risk_events
    description: Risk score history and trends
  - name: billing
    description: Billing accounts and invoices
  - name: notifications
    description: User notifications
  - name: integrations
    description: External system integrations

security:
  - BearerAuth: []

paths:
  # =============================================================================
  # TENANTS
  # =============================================================================
  /tenants/current:
    get:
      tags: [tenants]
      summary: Get current tenant information
      description: Returns the authenticated user's tenant details
      operationId: getCurrentTenant
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [tenants]
      summary: Update current tenant
      description: Update tenant settings (admin only)
      operationId: updateCurrentTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantUpdate'
      responses:
        '200':
          description: Tenant updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # USERS
  # =============================================================================
  /users:
    get:
      tags: [users]
      summary: List users in tenant
      description: Returns all users in the authenticated user's tenant
      operationId: listUsers
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: role
          in: query
          schema:
            $ref: '#/components/schemas/UserRole'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/UserStatus'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [users]
      summary: Create new user
      description: Create a new user in the tenant (admin only)
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /users/{userId}:
    get:
      tags: [users]
      summary: Get user by ID
      operationId: getUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [users]
      summary: Update user
      description: Update user profile (admin or self)
      operationId: updateUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [users]
      summary: Delete user
      description: Soft delete user (admin only)
      operationId: deleteUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '204':
          description: User deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /users/me:
    get:
      tags: [users]
      summary: Get current user profile
      operationId: getCurrentUser
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # SITES
  # =============================================================================
  /sites:
    get:
      tags: [sites]
      summary: List sites
      description: Returns sites accessible to the authenticated user
      operationId: listSites
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: criticality
          in: query
          schema:
            $ref: '#/components/schemas/Criticality'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Site'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [sites]
      summary: Create site
      description: Create a new site (admin only)
      operationId: createSite
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SiteCreate'
      responses:
        '201':
          description: Site created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /sites/{siteId}:
    get:
      tags: [sites]
      summary: Get site by ID
      operationId: getSite
      parameters:
        - $ref: '#/components/parameters/SiteId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [sites]
      summary: Update site
      description: Update site details (admin or manager)
      operationId: updateSite
      parameters:
        - $ref: '#/components/parameters/SiteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SiteUpdate'
      responses:
        '200':
          description: Site updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [sites]
      summary: Delete site
      description: Soft delete site (admin only)
      operationId: deleteSite
      parameters:
        - $ref: '#/components/parameters/SiteId'
      responses:
        '204':
          description: Site deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # SIGNALS
  # =============================================================================
  /signals:
    get:
      tags: [signals]
      summary: List signals
      description: Returns signals for accessible sites
      operationId: listSignals
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: site_id
          in: query
          schema:
            type: string
            format: uuid
        - name: signal_type
          in: query
          schema:
            $ref: '#/components/schemas/SignalType'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/SignalStatus'
        - name: from
          in: query
          description: Filter signals measured after this timestamp
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: Filter signals measured before this timestamp
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Signal'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [signals]
      summary: Create signal
      description: Ingest a new signal (contributor or higher)
      operationId: createSignal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignalCreate'
      responses:
        '201':
          description: Signal created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Signal'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /signals/batch:
    post:
      tags: [signals]
      summary: Batch create signals
      description: Ingest multiple signals at once (for high-volume data sources)
      operationId: batchCreateSignals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                signals:
                  type: array
                  items:
                    $ref: '#/components/schemas/SignalCreate'
                  maxItems: 1000
              required:
                - signals
      responses:
        '201':
          description: Signals created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: integer
                  failed:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        index:
                          type: integer
                        error:
                          type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # WORKFLOWS
  # =============================================================================
  /workflows:
    get:
      tags: [workflows]
      summary: List workflows
      description: Returns all workflows in the tenant
      operationId: listWorkflows
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: workflow_type
          in: query
          schema:
            $ref: '#/components/schemas/WorkflowType'
        - name: is_active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Workflow'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [workflows]
      summary: Create workflow
      description: Create a new workflow definition (manager or admin)
      operationId: createWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowCreate'
      responses:
        '201':
          description: Workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /workflows/{workflowId}:
    get:
      tags: [workflows]
      summary: Get workflow by ID
      operationId: getWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [workflows]
      summary: Update workflow
      operationId: updateWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowUpdate'
      responses:
        '200':
          description: Workflow updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # WORK ITEMS
  # =============================================================================
  /work-items:
    get:
      tags: [work_items]
      summary: List work items
      description: Returns work items accessible to the user
      operationId: listWorkItems
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: site_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/WorkflowStatus'
        - name: assigned_to
          in: query
          schema:
            type: string
            format: uuid
        - name: priority
          in: query
          schema:
            $ref: '#/components/schemas/WorkItemPriority'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkItem'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [work_items]
      summary: Create work item
      description: Create a new work item (contributor or higher)
      operationId: createWorkItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkItemCreate'
      responses:
        '201':
          description: Work item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /work-items/{workItemId}:
    get:
      tags: [work_items]
      summary: Get work item by ID
      operationId: getWorkItem
      parameters:
        - $ref: '#/components/parameters/WorkItemId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [work_items]
      summary: Update work item
      operationId: updateWorkItem
      parameters:
        - $ref: '#/components/parameters/WorkItemId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkItemUpdate'
      responses:
        '200':
          description: Work item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # RISK REGISTER
  # =============================================================================
  /risks:
    get:
      tags: [risks]
      summary: List risks
      description: Returns risks accessible to the user (with ownership bypass)
      operationId: listRisks
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: site_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/RiskStatus'
        - name: decision
          in: query
          schema:
            $ref: '#/components/schemas/RiskDecision'
        - name: owner_id
          in: query
          schema:
            type: string
            format: uuid
        - name: min_risk_score
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 25
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Risk'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [risks]
      summary: Create risk
      description: Create a new risk (contributor or higher)
      operationId: createRisk
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskCreate'
      responses:
        '201':
          description: Risk created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /risks/{riskId}:
    get:
      tags: [risks]
      summary: Get risk by ID
      operationId: getRisk
      parameters:
        - $ref: '#/components/parameters/RiskId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [risks]
      summary: Update risk
      description: Update risk (owner can always update their risks)
      operationId: updateRisk
      parameters:
        - $ref: '#/components/parameters/RiskId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskUpdate'
      responses:
        '200':
          description: Risk updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Risk'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  /risks/{riskId}/events:
    get:
      tags: [risk_events]
      summary: Get risk event history
      description: Returns historical risk score changes
      operationId: getRiskEvents
      parameters:
        - $ref: '#/components/parameters/RiskId'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RiskEvent'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # BILLING
  # =============================================================================
  /billing/account:
    get:
      tags: [billing]
      summary: Get billing account
      description: Get tenant billing account (admin or billing_admin only)
      operationId: getBillingAccount
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingAccount'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/invoices:
    get:
      tags: [billing]
      summary: List invoices
      description: List tenant invoices (admin or billing_admin only)
      operationId: listInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceStatus'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Invoice'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/invoices/{invoiceId}:
    get:
      tags: [billing]
      summary: Get invoice by ID
      operationId: getInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # NOTIFICATIONS
  # =============================================================================
  /notifications:
    get:
      tags: [notifications]
      summary: List user notifications
      description: Returns notifications for the authenticated user
      operationId: listNotifications
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: is_read
          in: query
          schema:
            type: boolean
        - name: type
          in: query
          schema:
            $ref: '#/components/schemas/NotificationType'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /notifications/{notificationId}/read:
    post:
      tags: [notifications]
      summary: Mark notification as read
      operationId: markNotificationRead
      parameters:
        - $ref: '#/components/parameters/NotificationId'
      responses:
        '200':
          description: Notification marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /notifications/read-all:
    post:
      tags: [notifications]
      summary: Mark all notifications as read
      operationId: markAllNotificationsRead
      responses:
        '200':
          description: All notifications marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # =============================================================================
  # INTEGRATIONS
  # =============================================================================
  /integrations:
    get:
      tags: [integrations]
      summary: List integrations
      description: List external integrations (admin only)
      operationId: listIntegrations
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: integration_type
          in: query
          schema:
            $ref: '#/components/schemas/IntegrationType'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/IntegrationStatus'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Integration'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [integrations]
      summary: Create integration
      description: Create a new external integration (admin only)
      operationId: createIntegration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntegrationCreate'
      responses:
        '201':
          description: Integration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Integration'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from Supabase Auth

  parameters:
    Limit:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    Offset:
      name: offset
      in: query
      description: Number of results to skip
      schema:
        type: integer
        minimum: 0
        default: 0

    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    SiteId:
      name: siteId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    WorkflowId:
      name: workflowId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    WorkItemId:
      name: workItemId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    RiskId:
      name: riskId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    InvoiceId:
      name: invoiceId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    NotificationId:
      name: notificationId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    # =============================================================================
    # ENUMS
    # =============================================================================
    Criticality:
      type: string
      enum: [critical, high, medium, low]

    Severity:
      type: string
      enum: [catastrophic, major, moderate, minor, negligible]

    Likelihood:
      type: string
      enum: [almost_certain, likely, possible, unlikely, rare]

    RiskDecision:
      type: string
      enum: [accept, mitigate, transfer, avoid, under_review]

    RiskStatus:
      type: string
      enum: [open, monitoring, closed, escalated]

    WorkflowStatus:
      type: string
      enum: [draft, pending, in_progress, blocked, completed, cancelled, failed]

    WorkflowType:
      type: string
      enum: [moc, approval, inspection, incident, audit, custom]

    WorkItemPriority:
      type: string
      enum: [urgent, high, medium, low]

    SignalStatus:
      type: string
      enum: [raw, validated, anomaly, error, ignored]

    SignalType:
      type: string
      enum: [sensor, event, alarm, maintenance, inspection, manual_entry]

    UserRole:
      type: string
      enum: [admin, manager, operator, viewer, auditor, contributor, billing_admin]

    UserStatus:
      type: string
      enum: [active, inactive, suspended, pending]

    IntegrationType:
      type: string
      enum: [sap, maximo, scada, historian, erp, cmms, api, webhook]

    IntegrationStatus:
      type: string
      enum: [active, inactive, error, degraded]

    NotificationType:
      type: string
      enum: [risk_alert, workflow, approval, deadline, system, mention]

    NotificationPriority:
      type: string
      enum: [urgent, high, normal, low]

    BillingPlan:
      type: string
      enum: [free, starter, professional, enterprise]

    BillingStatus:
      type: string
      enum: [active, trialing, past_due, cancelled, suspended]

    InvoiceStatus:
      type: string
      enum: [draft, pending, paid, overdue, void, refunded]

    # =============================================================================
    # COMMON SCHEMAS
    # =============================================================================
    Pagination:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer

    Timestamps:
      type: object
      properties:
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

    ValidationError:
      allOf:
        - $ref: '#/components/schemas/Error'
        - type: object
          properties:
            errors:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

    # =============================================================================
    # TENANT
    # =============================================================================
    Tenant:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - name
            - slug
            - billing_plan
            - billing_status
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            slug:
              type: string
            billing_plan:
              $ref: '#/components/schemas/BillingPlan'
            billing_status:
              $ref: '#/components/schemas/BillingStatus'
            trial_ends_at:
              type: string
              format: date-time
              nullable: true
            subscription_ends_at:
              type: string
              format: date-time
              nullable: true
            max_sites:
              type: integer
            max_users:
              type: integer
            max_signals_per_month:
              type: integer

    TenantUpdate:
      type: object
      properties:
        name:
          type: string
        max_sites:
          type: integer
        max_users:
          type: integer
        max_signals_per_month:
          type: integer

    # =============================================================================
    # USER
    # =============================================================================
    User:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - email
            - role
            - status
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            email:
              type: string
              format: email
            full_name:
              type: string
              nullable: true
            avatar_url:
              type: string
              nullable: true
            role:
              $ref: '#/components/schemas/UserRole'
            status:
              $ref: '#/components/schemas/UserStatus'
            site_ids:
              type: array
              items:
                type: string
                format: uuid
              nullable: true
            last_seen_at:
              type: string
              format: date-time
              nullable: true

    UserCreate:
      type: object
      required:
        - email
        - role
      properties:
        email:
          type: string
          format: email
        full_name:
          type: string
        role:
          $ref: '#/components/schemas/UserRole'
        site_ids:
          type: array
          items:
            type: string
            format: uuid

    UserUpdate:
      type: object
      properties:
        full_name:
          type: string
        avatar_url:
          type: string
        role:
          $ref: '#/components/schemas/UserRole'
        status:
          $ref: '#/components/schemas/UserStatus'
        site_ids:
          type: array
          items:
            type: string
            format: uuid

    # =============================================================================
    # SITE
    # =============================================================================
    Site:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - name
            - code
            - criticality
            - is_active
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            name:
              type: string
            code:
              type: string
            criticality:
              $ref: '#/components/schemas/Criticality'
            site_type:
              type: string
              nullable: true
            location:
              type: object
              nullable: true
            timezone:
              type: string
            is_active:
              type: boolean
            commissioned_at:
              type: string
              format: date-time
              nullable: true
            decommissioned_at:
              type: string
              format: date-time
              nullable: true

    SiteCreate:
      type: object
      required:
        - name
        - code
        - criticality
      properties:
        name:
          type: string
        code:
          type: string
        criticality:
          $ref: '#/components/schemas/Criticality'
        site_type:
          type: string
        location:
          type: object
        timezone:
          type: string

    SiteUpdate:
      type: object
      properties:
        name:
          type: string
        code:
          type: string
        criticality:
          $ref: '#/components/schemas/Criticality'
        site_type:
          type: string
        location:
          type: object
        timezone:
          type: string
        is_active:
          type: boolean

    # =============================================================================
    # SIGNAL
    # =============================================================================
    Signal:
      type: object
      required:
        - id
        - tenant_id
        - site_id
        - signal_type
        - source
        - status
        - measured_at
        - created_at
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        site_id:
          type: string
          format: uuid
        signal_type:
          $ref: '#/components/schemas/SignalType'
        source:
          type: string
        tag:
          type: string
          nullable: true
        value:
          type: number
          nullable: true
        unit:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/SignalStatus'
        quality_score:
          type: number
          minimum: 0
          maximum: 1
          nullable: true
        validation_notes:
          type: string
          nullable: true
        measured_at:
          type: string
          format: date-time
        received_at:
          type: string
          format: date-time
        processed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    SignalCreate:
      type: object
      required:
        - site_id
        - signal_type
        - source
      properties:
        site_id:
          type: string
          format: uuid
        signal_type:
          $ref: '#/components/schemas/SignalType'
        source:
          type: string
        tag:
          type: string
        value:
          type: number
        unit:
          type: string
        status:
          $ref: '#/components/schemas/SignalStatus'
        quality_score:
          type: number
          minimum: 0
          maximum: 1
        measured_at:
          type: string
          format: date-time
        metadata:
          type: object

    # =============================================================================
    # WORKFLOW
    # =============================================================================
    Workflow:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - name
            - workflow_type
            - definition
            - version
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            name:
              type: string
            description:
              type: string
              nullable: true
            workflow_type:
              $ref: '#/components/schemas/WorkflowType'
            definition:
              type: object
            is_template:
              type: boolean
            is_active:
              type: boolean
            version:
              type: integer
            parent_workflow_id:
              type: string
              format: uuid
              nullable: true

    WorkflowCreate:
      type: object
      required:
        - name
        - workflow_type
        - definition
      properties:
        name:
          type: string
        description:
          type: string
        workflow_type:
          $ref: '#/components/schemas/WorkflowType'
        definition:
          type: object
        is_template:
          type: boolean
        parent_workflow_id:
          type: string
          format: uuid

    WorkflowUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        definition:
          type: object
        is_active:
          type: boolean

    # =============================================================================
    # WORK ITEM
    # =============================================================================
    WorkItem:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - title
            - status
            - priority
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            site_id:
              type: string
              format: uuid
              nullable: true
            workflow_id:
              type: string
              format: uuid
              nullable: true
            title:
              type: string
            description:
              type: string
              nullable: true
            work_item_type:
              $ref: '#/components/schemas/WorkflowType'
            status:
              $ref: '#/components/schemas/WorkflowStatus'
            priority:
              $ref: '#/components/schemas/WorkItemPriority'
            assigned_to:
              type: string
              format: uuid
              nullable: true
            created_by:
              type: string
              format: uuid
              nullable: true
            due_at:
              type: string
              format: date-time
              nullable: true
            started_at:
              type: string
              format: date-time
              nullable: true
            completed_at:
              type: string
              format: date-time
              nullable: true
            data:
              type: object
            audit_trail:
              type: array
              items:
                type: object

    WorkItemCreate:
      type: object
      required:
        - title
        - priority
      properties:
        site_id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        work_item_type:
          $ref: '#/components/schemas/WorkflowType'
        priority:
          $ref: '#/components/schemas/WorkItemPriority'
        assigned_to:
          type: string
          format: uuid
        due_at:
          type: string
          format: date-time
        data:
          type: object

    WorkItemUpdate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/WorkflowStatus'
        priority:
          $ref: '#/components/schemas/WorkItemPriority'
        assigned_to:
          type: string
          format: uuid
        due_at:
          type: string
          format: date-time
        data:
          type: object

    # =============================================================================
    # RISK
    # =============================================================================
    Risk:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - site_id
            - risk_id
            - title
            - description
            - severity
            - likelihood
            - risk_score
            - owner_id
            - decision
            - status
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            site_id:
              type: string
              format: uuid
            risk_id:
              type: string
            title:
              type: string
            description:
              type: string
            category:
              type: string
              nullable: true
            severity:
              $ref: '#/components/schemas/Severity'
            likelihood:
              $ref: '#/components/schemas/Likelihood'
            risk_score:
              type: integer
              readOnly: true
            owner_id:
              type: string
              format: uuid
            decision:
              $ref: '#/components/schemas/RiskDecision'
            decision_rationale:
              type: string
              nullable: true
            decision_date:
              type: string
              format: date-time
              nullable: true
            decision_by:
              type: string
              format: uuid
              nullable: true
            status:
              $ref: '#/components/schemas/RiskStatus'
            existing_controls:
              type: string
              nullable: true
            mitigation_plan:
              type: string
              nullable: true
            target_completion_date:
              type: string
              format: date-time
              nullable: true
            related_work_item_id:
              type: string
              format: uuid
              nullable: true
            audit_trail:
              type: array
              items:
                type: object
            last_reviewed_at:
              type: string
              format: date-time
              nullable: true
            next_review_due:
              type: string
              format: date-time
              nullable: true
            closed_at:
              type: string
              format: date-time
              nullable: true

    RiskCreate:
      type: object
      required:
        - site_id
        - risk_id
        - title
        - description
        - severity
        - likelihood
        - owner_id
      properties:
        site_id:
          type: string
          format: uuid
        risk_id:
          type: string
        title:
          type: string
        description:
          type: string
        category:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        likelihood:
          $ref: '#/components/schemas/Likelihood'
        owner_id:
          type: string
          format: uuid
        decision:
          $ref: '#/components/schemas/RiskDecision'
        decision_rationale:
          type: string
        existing_controls:
          type: string
        mitigation_plan:
          type: string
        target_completion_date:
          type: string
          format: date-time

    RiskUpdate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        category:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        likelihood:
          $ref: '#/components/schemas/Likelihood'
        owner_id:
          type: string
          format: uuid
        decision:
          $ref: '#/components/schemas/RiskDecision'
        decision_rationale:
          type: string
        status:
          $ref: '#/components/schemas/RiskStatus'
        existing_controls:
          type: string
        mitigation_plan:
          type: string
        target_completion_date:
          type: string
          format: date-time
        next_review_due:
          type: string
          format: date-time

    # =============================================================================
    # RISK EVENT
    # =============================================================================
    RiskEvent:
      type: object
      required:
        - id
        - tenant_id
        - risk_id
        - event_type
        - severity
        - likelihood
        - risk_score
        - created_at
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        risk_id:
          type: string
          format: uuid
        event_type:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        likelihood:
          $ref: '#/components/schemas/Likelihood'
        risk_score:
          type: integer
        previous_severity:
          $ref: '#/components/schemas/Severity'
          nullable: true
        previous_likelihood:
          $ref: '#/components/schemas/Likelihood'
          nullable: true
        previous_risk_score:
          type: integer
          nullable: true
        notes:
          type: string
          nullable: true
        triggered_by:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time

    # =============================================================================
    # BILLING
    # =============================================================================
    BillingAccount:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - billing_email
            - status
            - current_plan
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            billing_email:
              type: string
              format: email
            billing_name:
              type: string
              nullable: true
            billing_address:
              type: object
              nullable: true
            payment_method_id:
              type: string
              nullable: true
            payment_method_type:
              type: string
              nullable: true
            status:
              $ref: '#/components/schemas/BillingStatus'
            current_plan:
              $ref: '#/components/schemas/BillingPlan'
            subscription_id:
              type: string
              nullable: true
            billing_cycle_start:
              type: string
              format: date
              nullable: true
            billing_cycle_end:
              type: string
              format: date
              nullable: true
            next_billing_date:
              type: string
              format: date
              nullable: true
            credit_balance:
              type: number

    Invoice:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - billing_account_id
            - invoice_number
            - status
            - subtotal
            - tax_amount
            - discount_amount
            - total_amount
            - amount_paid
            - amount_due
            - currency
            - invoice_date
            - due_date
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            billing_account_id:
              type: string
              format: uuid
            invoice_number:
              type: string
            status:
              $ref: '#/components/schemas/InvoiceStatus'
            subtotal:
              type: number
            tax_amount:
              type: number
            discount_amount:
              type: number
            total_amount:
              type: number
            amount_paid:
              type: number
            amount_due:
              type: number
              readOnly: true
            currency:
              type: string
            invoice_date:
              type: string
              format: date
            due_date:
              type: string
              format: date
            paid_at:
              type: string
              format: date-time
              nullable: true

    InvoiceDetail:
      allOf:
        - $ref: '#/components/schemas/Invoice'
        - type: object
          properties:
            line_items:
              type: array
              items:
                $ref: '#/components/schemas/InvoiceLineItem'

    InvoiceLineItem:
      type: object
      required:
        - id
        - invoice_id
        - description
        - quantity
        - unit_price
        - amount
      properties:
        id:
          type: string
          format: uuid
        invoice_id:
          type: string
          format: uuid
        description:
          type: string
        quantity:
          type: number
        unit_price:
          type: number
        amount:
          type: number
          readOnly: true
        item_type:
          type: string
          nullable: true

    # =============================================================================
    # NOTIFICATION
    # =============================================================================
    Notification:
      type: object
      required:
        - id
        - tenant_id
        - user_id
        - type
        - priority
        - title
        - message
        - is_read
        - created_at
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/NotificationType'
        priority:
          $ref: '#/components/schemas/NotificationPriority'
        title:
          type: string
        message:
          type: string
        action_url:
          type: string
          nullable: true
        is_read:
          type: boolean
        read_at:
          type: string
          format: date-time
          nullable: true
        related_entity_type:
          type: string
          nullable: true
        related_entity_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true

    # =============================================================================
    # INTEGRATION
    # =============================================================================
    Integration:
      allOf:
        - $ref: '#/components/schemas/Timestamps'
        - type: object
          required:
            - id
            - tenant_id
            - name
            - integration_type
            - status
          properties:
            id:
              type: string
              format: uuid
            tenant_id:
              type: string
              format: uuid
            name:
              type: string
            integration_type:
              $ref: '#/components/schemas/IntegrationType'
            status:
              $ref: '#/components/schemas/IntegrationStatus'
            last_sync_at:
              type: string
              format: date-time
              nullable: true
            last_error:
              type: string
              nullable: true
            last_error_at:
              type: string
              format: date-time
              nullable: true
            sync_frequency_minutes:
              type: integer

    IntegrationCreate:
      type: object
      required:
        - name
        - integration_type
        - config
      properties:
        name:
          type: string
        integration_type:
          $ref: '#/components/schemas/IntegrationType'
        config:
          type: object
        sync_frequency_minutes:
          type: integer

  responses:
    Unauthorized:
      description: Unauthorized - Invalid or missing authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized
            message: Authentication token is required

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: forbidden
            message: You do not have permission to perform this action

    NotFound:
      description: Not found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: not_found
            message: The requested resource was not found

    ValidationError:
      description: Validation error - Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            error: validation_error
            message: Request validation failed
            errors:
              - field: email
                message: Invalid email format
              - field: site_id
                message: Site ID is required

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: internal_error
            message: An unexpected error occurred
